<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Breaker — Display</title>
  <link rel="stylesheet" href="https://api.fontshare.com/v2/css?f[]=clash-display@700&display=swap">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>
  <style>
    *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

    html, body {
      width: 100%; height: 100%;
      overflow: hidden;
      background: #2A0002;
      font-family: ui-sans-serif, system-ui, sans-serif;
    }

    #blob-layer {
      position: fixed; inset: 0;
      filter: blur(90px) saturate(1.15);
    }

    .blob {
      position: absolute;
      border-radius: 50%;
      will-change: left, top;
    }

    #grain {
      position: fixed; inset: 0;
      pointer-events: none;
      z-index: 50;
      opacity: 0.22;
      mix-blend-mode: overlay;
    }

    #content {
      position: fixed; inset: 0;
      z-index: 100;
      pointer-events: none;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      padding: 4vw;
    }

    #countdown-wrap {
      display: flex;
      justify-content: flex-end;
      padding-right: 4vw;
      padding-bottom: 3vw;
    }

    .countdown-digit, .countdown-colon {
      display: inline-block;
      text-align: center;
    }
  </style>
</head>
<body>

  <div id="blob-layer"></div>
  <canvas id="grain"></canvas>

  <div id="content">
    <div>
      <div id="live-clock" style="color:rgba(255,255,255,0.4); font-size:0.85rem; letter-spacing:0.1em; margin-bottom:0.5rem;"></div>
      <div id="event-title" style="color:#fff; font-weight:700; font-size:2.5rem; line-height:1.15;"></div>
      <div id="event-subtitle" style="color:rgba(255,255,255,0.55); font-size:1.25rem; margin-top:0.35rem;"></div>
    </div>
    <div id="countdown-wrap">
      <div id="countdown-display" style="color:#fff; font-family:'Clash Display',sans-serif; font-weight:700; font-size:18vw; line-height:0.9;"></div>
      <div id="zero-message" style="display:none; color:#fff; font-family:'Clash Display',sans-serif; font-weight:700; font-size:6vw; line-height:1;">Session Starting Now</div>
    </div>
  </div>

  <script>
    // ─── THEMES ──────────────────────────────────────────────────────────────
    const BASE_BLOBS = [
      { sz:0.78, sx:0.22, sy:0.66, ax:0.13, ay:0.11, vx:2.8e-4, vy:3.5e-4, px:0.00, py:1.20 },
      { sz:0.68, sx:0.72, sy:0.26, ax:0.11, ay:0.13, vx:3.4e-4, vy:2.7e-4, px:2.10, py:0.80 },
      { sz:0.60, sx:0.52, sy:0.74, ax:0.14, ay:0.10, vx:4.1e-4, vy:3.8e-4, px:4.00, py:3.50 },
      { sz:0.44, sx:0.17, sy:0.20, ax:0.09, ay:0.08, vx:3.0e-4, vy:4.0e-4, px:1.00, py:4.80 },
      { sz:0.38, sx:0.80, sy:0.54, ax:0.10, ay:0.11, vx:3.8e-4, vy:3.0e-4, px:3.20, py:2.00 },
      { sz:0.55, sx:0.44, sy:0.38, ax:0.08, ay:0.10, vx:2.5e-4, vy:3.2e-4, px:5.50, py:1.50 },
      { sz:0.42, sx:0.86, sy:0.84, ax:0.11, ay:0.09, vx:3.5e-4, vy:2.8e-4, px:0.50, py:3.00 },
      { sz:0.50, sx:0.08, sy:0.50, ax:0.07, ay:0.12, vx:2.2e-4, vy:3.3e-4, px:6.00, py:0.40 },
    ];

    const THEMES = {
      crimson: { bg:'#2A0002', colors:[
        {hex:'#B60006',alpha:0.90},{hex:'#8A0005',alpha:0.85},{hex:'#D4000A',alpha:0.80},
        {hex:'#F6EFE7',alpha:0.95},{hex:'#FFFFFF',alpha:0.88},{hex:'#B60006',alpha:0.75},
        {hex:'#F6EFE7',alpha:0.70},{hex:'#8A0005',alpha:0.72}]},
      midnight: { bg:'#060D1A', colors:[
        {hex:'#1236d9',alpha:0.90},{hex:'#0c22cc',alpha:0.85},{hex:'#1a3df5',alpha:0.80},
        {hex:'#ffffff',alpha:0.95},{hex:'#ffffff',alpha:0.88},{hex:'#2244ff',alpha:0.75},
        {hex:'#c8d8ff',alpha:0.70},{hex:'#0f25cc',alpha:0.72}]},
      ember: { bg:'#1A0E00', colors:[
        {hex:'#FF6B00',alpha:0.90},{hex:'#CC5500',alpha:0.85},{hex:'#FF8C00',alpha:0.80},
        {hex:'#FFD700',alpha:0.95},{hex:'#FFFFFF',alpha:0.88},{hex:'#FF6B00',alpha:0.75},
        {hex:'#FFD700',alpha:0.70},{hex:'#CC5500',alpha:0.72}]},
    };

    // ─── STATE ───────────────────────────────────────────────────────────────
    const STORAGE_KEY = 'breaker_state';
    const defaultState = { endTime:null, paused:false, remaining:0, theme:'crimson', title:'', subtitle:'' };
    let state = { ...defaultState };

    function loadState() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (raw) state = { ...defaultState, ...JSON.parse(raw) };
      } catch(e) {}
    }

    // ─── BLOBS ───────────────────────────────────────────────────────────────
    const layer = document.getElementById('blob-layer');
    let blobEls = [];

    function buildGradient(hex, alpha) {
      const a1 = Math.round(alpha * 255).toString(16).padStart(2,'0');
      const a2 = Math.round(alpha * 0.45 * 255).toString(16).padStart(2,'0');
      return `radial-gradient(circle, ${hex}${a1} 0%, ${hex}${a2} 42%, transparent 72%)`;
    }

    function rebuildBlobs(themeKey) {
      layer.innerHTML = '';
      blobEls = [];
      const theme = THEMES[themeKey] || THEMES.crimson;
      document.body.style.background = theme.bg;
      BASE_BLOBS.forEach((b, i) => {
        const c = theme.colors[i];
        const base = Math.max(window.innerWidth, window.innerHeight);
        const el = document.createElement('div');
        el.className = 'blob';
        el.style.cssText = `width:${base*b.sz}px;height:${base*b.sz}px;background:${buildGradient(c.hex,c.alpha)};left:${b.sx*100}%;top:${b.sy*100}%;transform:translate(-50%,-50%);`;
        layer.appendChild(el);
        blobEls.push({ el, ...b });
      });
    }

    (function animateBlobs(t) {
      for (const b of blobEls) {
        b.el.style.left = ((b.sx + b.ax * Math.sin(t * b.vx + b.px)) * 100) + '%';
        b.el.style.top  = ((b.sy + b.ay * Math.cos(t * b.vy + b.py)) * 100) + '%';
      }
      requestAnimationFrame(animateBlobs);
    })();

    // ─── GRAIN ───────────────────────────────────────────────────────────────
    const grainCanvas = document.getElementById('grain');
    const gCtx = grainCanvas.getContext('2d');
    function paintGrain() {
      const w = window.innerWidth, h = window.innerHeight;
      grainCanvas.width = w; grainCanvas.height = h;
      const img = gCtx.createImageData(w, h);
      let seed = (Math.random() * 0xffffffff) >>> 0;
      for (let i = 0; i < img.data.length; i += 4) {
        seed = (seed * 1664525 + 1013904223) & 0xffffffff;
        const v = seed >>> 24;
        img.data[i] = img.data[i+1] = img.data[i+2] = v; img.data[i+3] = 255;
      }
      gCtx.putImageData(img, 0, 0);
    }
    paintGrain();
    window.addEventListener('resize', paintGrain);

    // ─── DISPLAY ─────────────────────────────────────────────────────────────
    const $clock      = document.getElementById('live-clock');
    const $title      = document.getElementById('event-title');
    const $subtitle   = document.getElementById('event-subtitle');
    const $countdown  = document.getElementById('countdown-display');
    const $zeroMsg    = document.getElementById('zero-message');
    let lastDigits = '';

    function updateClock() {
      $clock.textContent = new Date().toLocaleTimeString('en-US', { hour12: false });
    }
    updateClock();
    setInterval(updateClock, 1000);

    function buildDigitSpans(mmss) {
      return [...mmss].map(ch =>
        ch === ':' ? `<span class="countdown-colon">:</span>`
                   : `<span class="countdown-digit">${ch}</span>`
      ).join('');
    }

    function updateCountdownDisplay(ms) {
      const totalSec = Math.min(Math.ceil(ms / 1000), 5999);
      const m = Math.floor(totalSec / 60), s = totalSec % 60;
      const mmss = String(m).padStart(2,'0') + ':' + String(s).padStart(2,'0');

      if (ms <= 0) {
        $countdown.style.display = 'none';
        $zeroMsg.style.display = 'block';
        lastDigits = '';
        return;
      }

      $countdown.style.display = 'block';
      $zeroMsg.style.display = 'none';

      if (!$countdown.querySelector('.countdown-digit')) {
        $countdown.innerHTML = buildDigitSpans(mmss);
        lastDigits = mmss;
        return;
      }

      const spans = $countdown.querySelectorAll('.countdown-digit');
      const newChars = mmss.replace(':','');
      const oldChars = lastDigits.replace(':','');
      spans.forEach((span, i) => {
        if (newChars[i] !== oldChars[i]) {
          const ch = newChars[i];
          gsap.to(span, { y:-4, opacity:0, duration:0.1, ease:'power2.in', overwrite:true,
            onComplete() {
              span.textContent = ch;
              gsap.fromTo(span, {y:4,opacity:0}, {y:0,opacity:1,duration:0.1,ease:'power2.out',overwrite:true});
            }
          });
        }
      });
      lastDigits = mmss;
    }

    function getRemainingMs() {
      if (state.paused) return state.remaining;
      if (!state.endTime) return 0;
      return Math.max(0, state.endTime - Date.now());
    }

    setInterval(() => updateCountdownDisplay(getRemainingMs()), 250);

    function applyState() {
      rebuildBlobs(state.theme);
      $title.textContent = state.title;
      $subtitle.textContent = state.subtitle;
      lastDigits = '';
      $countdown.innerHTML = '';
      updateCountdownDisplay(getRemainingMs());
    }

    // ─── REAL-TIME SYNC FROM ADMIN ────────────────────────────────────────────
    const channel = new BroadcastChannel('breaker');
    channel.onmessage = (e) => {
      if (e.data.type === 'state_update') {
        state = e.data.state;
        applyState();
      }
    };

    // Fallback: localStorage storage event (different browser windows)
    window.addEventListener('storage', (e) => {
      if (e.key === STORAGE_KEY) {
        loadState();
        applyState();
      }
    });

    // ─── INIT ─────────────────────────────────────────────────────────────────
    loadState();
    applyState();
  </script>
</body>
</html>
